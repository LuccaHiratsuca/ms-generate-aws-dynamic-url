<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Upload de Imagem para S3</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #eef2f7;
        }

        header {
            background: #1a73e8;
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
        }

        nav a {
            color: white;
            margin-left: 20px;
            text-decoration: none;
            font-weight: bold;
        }

        nav a:hover { text-decoration: underline; }

        .container {
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 4px 12px #0002;
        }

        h2 { margin-top: 0; }

        .step {
            margin-bottom: 25px;
            padding: 18px;
            border-left: 5px solid #ccc;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .step.ok     { border-color: #1a73e8; }
        .step.error  { border-color: #c62828; }

        .hidden { display: none; }

        #presigned-url {
            word-break: break-all;
            font-size: 14px;
            background: #f2f6ff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #cbd6f1;
            margin-top: 8px;
        }

        button {
            padding: 14px 18px;
            font-size: 16px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover { background: #155ac1; }

        #log {
            background: #0d1117;
            color: #e6edf3;
            padding: 18px;
            border-radius: 8px;
            margin-top: 25px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-left: 6px;
        }

        .tag-pending { background: #ffecb3; color: #8d6e00; }
        .tag-ok      { background: #c8e6c9; color: #256029; }
        .tag-error   { background: #ffcdd2; color: #b71c1c; }
    </style>
</head>

<body>

<header>
    <h1>Upload de Imagem</h1>
    <nav>
        <a href="/home">Home</a>
        <a href="/upload">Upload</a>
        <a href="/list">Listar</a>
    </nav>
</header>

<div class="container">

    <h2>Enviar Imagem para o S3</h2>

    <div class="step" id="step1">
        <strong>1) Selecionar arquivo</strong>
        <span class="status-tag tag-pending" id="tag-step1">Aguardando</span>
        <br><br>
        <input type="file" id="file-input" accept="image/*">
    </div>

    <div class="step" id="step2">
        <strong>2) Solicitar URL pr√©-assinada ao backend</strong>
        <span class="status-tag tag-pending" id="tag-step2">Aguardando</span>
        <div id="presigned-url" class="hidden"></div>
    </div>

    <div class="step" id="step3">
        <strong>3) Enviar imagem direto para o S3 via PUT</strong>
        <span class="status-tag tag-pending" id="tag-step3">Aguardando</span>
    </div>

    <button onclick="startUpload()">Enviar arquivo</button>

    <h3>Log do processo</h3>
    <div id="log">Aguardando a√ß√£o...</div>

</div>

<script>
function log(msg) {
    document.getElementById("log").innerHTML += msg + "\n";
}

function setStatus(step, type) {
    const tag = document.getElementById("tag-" + step);
    tag.classList.remove("tag-pending", "tag-ok", "tag-error");

    if (type === "ok") {
        tag.classList.add("tag-ok");
        tag.textContent = "Conclu√≠do";
    } else if (type === "error") {
        tag.classList.add("tag-error");
        tag.textContent = "Erro";
    } else {
        tag.classList.add("tag-pending");
        tag.textContent = "Aguardando";
    }
}

async function startUpload() {

    // STEP 1 ---------------------------------------------
    const file = document.getElementById("file-input").files[0];
    if (!file) {
        alert("Selecione um arquivo primeiro.");
        return;
    }

    setStatus("step1", "ok");
    log(`‚úî Arquivo selecionado: ${file.name} (${file.type})`);

    // STEP 2 ---------------------------------------------
    log("üîÑ Solicitando URL pr√©-assinada ao backend...");

    let url;
    try {
        const res = await fetch(`/generate-upload-url?file_name=${file.name}&file_type=${file.type}`);
        const data = await res.json();
        url = data.upload_url;

        setStatus("step2", "ok");
        log("‚úî URL pr√©-assinada recebida.");

        const urlBox = document.getElementById("presigned-url");
        urlBox.classList.remove("hidden");
        urlBox.textContent = url;

    } catch (err) {
        setStatus("step2", "error");
        log("‚ùå Erro ao solicitar URL pr√©-assinada.");
        return;
    }

    // STEP 3 ---------------------------------------------
    log("üîÑ Enviando arquivo ao S3 via PUT...");

    try {
        const upload = await fetch(url, {
            method: "PUT",
            body: file,
            headers: { "Content-Type": file.type }
        });

        if (upload.ok) {
            setStatus("step3", "ok");
            log("‚úî Upload conclu√≠do com sucesso!");
        } else {
            throw new Error(upload.status);
        }

    } catch (err) {
        setStatus("step3", "error");
        log(err)
        log("‚ùå Falha no upload para o S3.");
    }
}
</script>
</body>
</html>
